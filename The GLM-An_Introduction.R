## ----toDoTOC, echo=FALSE, eval=FALSE-----------------------------------------------------------------------------------------------------------------------


## ----------------------------------------------------------------------------------------------------------------------------------------------------------
x <- c(1,1,2,2)
f <- formula(~ x)
model.matrix(f)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------
model.matrix(f)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------
x <- factor(c(1,1,2,2))
model.matrix(~ x)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------
x <- factor(c(1,1,2,2))
model.matrix(~ x + 0)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------
x <- factor(c(1,1,2,2,3,3))
model.matrix(~ x)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------
x <- factor(c(1,1,2,2,3,3))
model.matrix(~ x + 0)


## ----readTargets-------------------------------------------------------------------------------------------------------------------------------------------
url <- "https://raw.githubusercontent.com/ASPteaching"
repo <- "Introduction_to_Design_of_Experiments"
folder <- "main/omicsData/dataset_2_Breast_cancer_GSE1561/data"
dataFile <- "BreastCancerGSE1561.csv"
targetsFile <- "targets.txt"
targetsFileName <- paste(url, repo, folder, targetsFile, sep="/")


## ----readTargets2------------------------------------------------------------------------------------------------------------------------------------------
library(magrittr)
targets <-read.table(targetsFileName, row.names=1, head=T)


## ----readTargets3------------------------------------------------------------------------------------------------------------------------------------------
kableExtra::kable(head(targets[,1:6]), n=7) %>% kableExtra::kable_styling()


## ----designMatrix1a----------------------------------------------------------------------------------------------------------------------------------------
design<-matrix(
  c(1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,1,1,1,1,1),
  nrow=15,byrow=F)
colnames(design) <-c("A", "B", "L")
rownames(design)<-  targets$Sample


## ----designMatrix1b----------------------------------------------------------------------------------------------------------------------------------------
print(design)


## ----designMatrix2a----------------------------------------------------------------------------------------------------------------------------------------
design2 <-model.matrix(~ 0+targets$Group)
colnames(design2)<-c("A", "B", "L")
rownames(design2)<-  targets$Sample


## ----designMatrix2b----------------------------------------------------------------------------------------------------------------------------------------
print(design2)


## ----contrastsMatrix---------------------------------------------------------------------------------------------------------------------------------------
library(limma)
cont.matrix <- makeContrasts (
  AvsB = B-A,
  AvsL = L-A,
  BvsL = L-B,
  levels=design)
cont.matrix


## ----readData----------------------------------------------------------------------------------------------------------------------------------------------
dataFile <- "BreastCancerGSE1561.csv"
dataFileName <- paste(url, repo, folder, dataFile, sep="/")

dataMatrix <- read.csv(dataFileName, row.names=1)

colnames(dataMatrix)==rownames(targets)
dim(dataMatrix)


## ----fitModel----------------------------------------------------------------------------------------------------------------------------------------------
fit<-lmFit(dataMatrix, design)
fit.main<-contrasts.fit(fit, cont.matrix)
fit.main<-eBayes(fit.main)


## ----extractResults----------------------------------------------------------------------------------------------------------------------------------------
topTab_AvsB <- topTable (fit.main, number=nrow(fit.main), coef="AvsB", adjust="fdr")
kableExtra::kable(head(topTab_AvsB, n=5)) %>% kableExtra::kable_styling()
# topTab_AvsL <- topTable (fit.main, number=nrow(fit.main), coef="AvsL", adjust="fdr"); head(topTab_AvsL)
# topTab_BvsL  <- topTable (fit.main, number=nrow(fit.main) , coef="BvsL", adjust="fdr"); head(topTab_BvsL)


## ----showResults, out.width="100%"-------------------------------------------------------------------------------------------------------------------------
volcanoplot(fit.main, coef="AvsB", 
            highlight=10)

